{% extends "base.html" %}

{% block title %}Trading Dashboard - XRP Arbitrage System{% endblock %}

{% block content %}
<div class="row">
    <!-- Price Display Panel -->
    <div class="col-lg-8">
        <div class="card trading-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Real-Time Market Data
                </h5>
                <span class="badge bg-primary" id="price-update-status">Live</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="price-display">
                            <div class="price-label">XRP/USDT</div>
                            <div class="price-value" id="xrp-usdt-price">$0.0000</div>
                            <div class="price-change" id="xrp-usdt-change">+0.00%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="price-display">
                            <div class="price-label">XRP/USDC</div>
                            <div class="price-value" id="xrp-usdc-price">$0.0000</div>
                            <div class="price-change" id="xrp-usdc-change">+0.00%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="spread-display">
                            <div class="price-label">Spread</div>
                            <div class="spread-value" id="spread-value">0.00%</div>
                            <div class="spread-indicator" id="spread-indicator">
                                <i class="fas fa-circle text-secondary"></i> No Opportunity
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Chart -->
                <div class="mt-4">
                    <canvas id="priceChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Control Panel -->
    <div class="col-lg-4">
        <div class="card trading-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>Trading Controls
                </h5>
            </div>
            <div class="card-body">
                <!-- Trading Status -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Trading Status:</span>
                        <span class="badge bg-secondary" id="trading-status">Stopped</span>
                    </div>
                </div>
                
                <!-- Configuration Summary -->
                <div class="config-summary mb-3">
                    <h6 class="text-muted mb-2">Configuration</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span>Spread Threshold:</span>
                            <span>{{ "%.3f"|format(config.spread_threshold if config else 0.003) }}%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Trade Amount:</span>
                            <span>{{ config.trade_amount if config else 100 }} XRP</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Daily Limit:</span>
                            <span>{{ config.daily_max_volume if config else 5000 }} XRP</span>
                        </div>
                    </div>
                </div>
                
                <!-- Control Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="start-trading-btn" onclick="startTrading()">
                        <i class="fas fa-play me-2"></i>Start Trading
                    </button>
                    <button class="btn btn-danger" id="stop-trading-btn" onclick="stopTrading()" disabled>
                        <i class="fas fa-stop me-2"></i>Stop Trading
                    </button>
                </div>
                
                <!-- System Status -->
                <div class="mt-3 pt-3 border-top border-secondary">
                    <h6 class="text-muted mb-2">System Status</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span>API Connection:</span>
                            <span class="text-success" id="api-status">
                                <i class="fas fa-check-circle"></i> Connected
                            </span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Pending Orders:</span>
                            <span id="pending-orders">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Last Update:</span>
                            <span class="text-muted" id="last-price-update">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Balance Panel -->
    <div class="col-lg-6">
        <div class="card trading-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-wallet me-2"></i>Wallet Balances
                </h5>
            </div>
            <div class="card-body">
                <div class="balance-grid">
                    <div class="balance-item">
                        <div class="balance-currency">XRP</div>
                        <div class="balance-amount" id="xrp-balance">0.00</div>
                        <div class="balance-locked">Locked: <span id="xrp-locked">0.00</span></div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-currency">USDT</div>
                        <div class="balance-amount" id="usdt-balance">0.00</div>
                        <div class="balance-locked">Locked: <span id="usdt-locked">0.00</span></div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-currency">USDC</div>
                        <div class="balance-amount" id="usdc-balance">0.00</div>
                        <div class="balance-locked">Locked: <span id="usdc-locked">0.00</span></div>
                    </div>
                </div>
                
                <!-- Portfolio Summary -->
                <div class="mt-3 pt-3 border-top border-secondary">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Portfolio Total:</span>
                        <span class="fw-bold text-primary" id="portfolio-total">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Today's Summary -->
    <div class="col-lg-6">
        <div class="card trading-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Today's Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-value" id="today-trades">{{ today_stats.total_trades if today_stats else 0 }}</div>
                            <div class="stat-label">Total Trades</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-value profit-loss" id="today-pnl">
                                ${{ "%.2f"|format(today_stats.total_profit_loss if today_stats else 0) }}
                            </div>
                            <div class="stat-label">P&L</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-value" id="today-volume">{{ "%.0f"|format(today_stats.total_volume if today_stats else 0) }}</div>
                            <div class="stat-label">Volume (XRP)</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-value" id="success-rate">{{ "%.1f"|format(today_stats.success_rate if today_stats else 0) }}%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card trading-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Activity
                </h5>
                <a href="{{ url_for('monitor') }}" class="btn btn-sm btn-outline-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i>Full Monitor
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Pair</th>
                                <th>Amount</th>
                                <th>Price</th>
                                <th>P&L</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trades">
                            <tr>
                                <td colspan="7" class="text-center text-muted">No recent trades</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        initializePriceChart();
        
        // Start periodic updates
        setInterval(updatePrices, 2000);
        setInterval(updateBalances, 5000);
        setInterval(updateTodayStats, 10000);
        setInterval(updateRecentTrades, 15000);
        
        // Initial data load
        updatePrices();
        updateBalances();
        updateTodayStats();
        updateRecentTrades();
        updateSystemStatus();
    });
</script>
{% endblock %}
