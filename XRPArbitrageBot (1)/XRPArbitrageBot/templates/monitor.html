{% extends "base.html" %}

{% block title %}Trading Monitor - XRP Arbitrage System{% endblock %}

{% block content %}
<div class="row">
    <!-- Live Trading Feed -->
    <div class="col-lg-8">
        <div class="card trading-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-stream me-2"></i>Live Trading Activity
                </h5>
                <div>
                    <span class="badge bg-success me-2" id="feed-status">Live</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearTradingFeed()">
                        <i class="fas fa-trash-alt"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="trading-feed" id="trading-feed">
                    <div class="feed-item text-center text-muted py-4">
                        <i class="fas fa-clock me-2"></i>Waiting for trading activity...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analytics Panel -->
    <div class="col-lg-4">
        <div class="card trading-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-analytics me-2"></i>Performance Analytics
                </h5>
            </div>
            <div class="card-body">
                <!-- Key Metrics -->
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-value profit-loss" id="total-pnl">$0.00</div>
                        <div class="metric-label">Total P&L</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="win-rate">0%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avg-trade">$0.00</div>
                        <div class="metric-label">Avg Trade</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="max-drawdown">$0.00</div>
                        <div class="metric-label">Max Drawdown</div>
                    </div>
                </div>
                
                <!-- Risk Indicators -->
                <div class="mt-3 pt-3 border-top border-secondary">
                    <h6 class="text-muted mb-2">Risk Monitoring</h6>
                    <div class="risk-indicators">
                        <div class="risk-item">
                            <span>Risk Score:</span>
                            <span class="badge bg-success" id="risk-score">Low</span>
                        </div>
                        <div class="risk-item">
                            <span>Volatility:</span>
                            <span id="volatility-level">Normal</span>
                        </div>
                        <div class="risk-item">
                            <span>Daily Volume:</span>
                            <span id="daily-volume-usage">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card trading-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>Quick Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="quick-stats">
                    <div class="stat-row">
                        <span>Active Since:</span>
                        <span id="active-since">--</span>
                    </div>
                    <div class="stat-row">
                        <span>Opportunities Today:</span>
                        <span id="opportunities-today">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Execution Rate:</span>
                        <span id="execution-rate">0%</span>
                    </div>
                    <div class="stat-row">
                        <span>Best Spread:</span>
                        <span id="best-spread">0.00%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card trading-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>P&L Trend
                </h5>
                <select class="form-select form-select-sm" style="width: auto;" id="pnl-timeframe">
                    <option value="24h">24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                </select>
            </div>
            <div class="card-body">
                <canvas id="pnlChart" height="120"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card trading-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Trade Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="distributionChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card trading-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Spread Analysis
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="updateSpreadChart('1h')">1H</button>
                    <button type="button" class="btn btn-outline-secondary active" onclick="updateSpreadChart('6h')">6H</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="updateSpreadChart('24h')">24H</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="spreadChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card trading-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Trade History Query
                </h5>
            </div>
            <div class="card-body">
                <form id="history-query-form">
                    <div class="mb-3">
                        <label class="form-label">Time Period</label>
                        <select class="form-select" id="query-period">
                            <option value="1h">Last Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Trade Status</label>
                        <select class="form-select" id="query-status">
                            <option value="all">All Trades</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Trading Pair</label>
                        <select class="form-select" id="query-pair">
                            <option value="all">All Pairs</option>
                            <option value="XRP/USDT">XRP/USDT</option>
                            <option value="XRP/USDC">XRP/USDC</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-primary w-100" onclick="executeHistoryQuery()">
                        <i class="fas fa-search me-2"></i>Query History
                    </button>
                </form>
                
                <!-- Query Results Summary -->
                <div class="mt-3 pt-3 border-top border-secondary" id="query-results" style="display: none;">
                    <h6 class="text-muted mb-2">Query Results</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span>Total Trades:</span>
                            <span id="query-total">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Total Volume:</span>
                            <span id="query-volume">0 XRP</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Net P&L:</span>
                            <span id="query-pnl" class="profit-loss">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Trade Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card trading-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Detailed Trade History
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportTradeHistory()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-dark table-hover table-sm">
                        <thead class="sticky-top">
                            <tr>
                                <th>Timestamp</th>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Pair</th>
                                <th>Amount</th>
                                <th>Price</th>
                                <th>Total Value</th>
                                <th>P&L</th>
                                <th>Status</th>
                                <th>Order ID</th>
                            </tr>
                        </thead>
                        <tbody id="detailed-trades">
                            <tr>
                                <td colspan="10" class="text-center text-muted">No trades found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/monitor.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<script>
    // Initialize monitor
    document.addEventListener('DOMContentLoaded', function() {
        initializeMonitor();
        initializePnlChart();
        initializeDistributionChart();
        initializeSpreadChart();
        
        // Start periodic updates
        setInterval(updateTradingFeed, 3000);
        setInterval(updateAnalytics, 10000);
        setInterval(updateCharts, 30000);
        
        // Initial data load
        updateAnalytics();
        loadInitialTrades();
        updateCharts();
    });
    
    // Real-time feed updates
    function updateTradingFeed() {
        fetchRecentTrades(20).then(trades => {
            if (trades && trades.length > 0) {
                updateFeedWithTrades(trades);
            }
        });
    }
</script>
{% endblock %}
